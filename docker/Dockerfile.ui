FROM node:20-alpine AS base
# -------- deps --------
FROM base AS deps
RUN apk add --no-cache libc6-compat
WORKDIR /app
# keep-ui is your root UI folder; copy only manifests first for caching
COPY keep-ui/package*.json ./
RUN npm ci --no-audit --no-fund --maxsockets 1

# -------- builder --------
FROM base AS builder
WORKDIR /app
COPY --from=deps /app/node_modules ./node_modules
# copy ONLY the UI sources into /app
COPY keep-ui/ ./

# make the build script executable and fix CRLF if needed
RUN sed -i 's/\r$//' next_build.sh && chmod +x next_build.sh

ENV NEXT_TELEMETRY_DISABLED=1
# expose your API base to the browser
ARG NEXT_PUBLIC_API_URL=/api
ENV NEXT_PUBLIC_API_URL=${NEXT_PUBLIC_API_URL}

# if your VM is small, this helps Next build
ENV NODE_OPTIONS=--max-old-space-size=4096

# RUN apk add --no-cache python3 make g++

RUN npm run build

# -------- runner --------
FROM base AS runner
WORKDIR /app

ARG GIT_COMMIT_HASH=local
ARG KEEP_VERSION=local
ARG KEEP_INCLUDE_SOURCES=false

ENV NODE_ENV=production \
    NEXT_TELEMETRY_DISABLED=1 \
    PORT=3000 \
    GIT_COMMIT_HASH=${GIT_COMMIT_HASH} \
    KEEP_VERSION=${KEEP_VERSION} \
    KEEP_INCLUDE_SOURCES=${KEEP_INCLUDE_SOURCES}

# non-root user
RUN addgroup --system --gid 1001 nodejs && adduser --system --uid 1001 nextjs

# Next.js standalone output + static
COPY --from=builder /app/public ./public
COPY --from=builder --chown=nextjs:nodejs /app/.next/standalone ./
COPY --from=builder --chown=nextjs:nodejs /app/.next/static ./.next/static

# entrypoint must live in keep-ui/ in your repo
COPY keep-ui/entrypoint.sh /app/entrypoint.sh
RUN chmod +x /app/entrypoint.sh \
 && chgrp -R 0 /app && chmod -R g=u /app

USER nextjs
EXPOSE 3000
ENTRYPOINT ["/app/entrypoint.sh"]
